{% extends 'base.html.twig' %}

{% block title %}Kampagnendetails{% endblock %}

{% block body %}

    <div class="mb-4 d-flex justify-content-between">
        <div>
            <h1 class="mb-3">Kampagne {{ campaign.name }}</h1>
            <span
                id="campaign-lifecycle-badge"
                class="badge {{ campaign.lifecycle.badgeClass }}">{{ campaign.lifecycle.asLabel|capitalize }}</span>

            {% if campaign.lifeCycle is not same as (enum('App\\Enum\\CampaignLifecycle').ARCHIVED) %}    
            <span
                id="campaign-status-badge"
                class="badge {{ campaign.status.badgeClass }}">{{ campaign.status.value }}</span>
            {% endif %}
        </div>

        {% if is_granted('CAMPAIGN_EDIT', campaign) %}
            <form
                action="{{ path('app_campaign_toggle_lifecycle', {id: campaign.id}) }}"
                method="post"
                id="form-campaign-lifecycle"
            >
                <input type="hidden" name="_token" value="{{ csrf_token('lifecycle' ~ campaign.id) }}">
                <div class="form-check form-switch">
                    <input
                        class="form-check-input"
                        type="checkbox"
                        role="switch"
                        id="toggle-switch-lifecycle" {{ campaign.lifecycle.asValue == '1' ? 'checked' : '' }}>
                    <label class="form-check-label" for="toggle-switch-lifecycle" id="toggle-switch-lifecycle-lable">
                        {{ campaign.lifecycle.asValue == '1' ? 'Archivieren' : 'Aktivieren' }}
                    </label>
                </div>
            </form>
        {% endif %}
    </div>

    <table class="table mb-5">
        <tbody>
        <tr>
            <th>Kampagne</th>
            <td>{{ campaign.name }}</td>
        </tr>
        <tr>
            <th>Plattform</th>
            <td>{{ campaign.platform }}</td>
        </tr>
        <tr>
            <th>Kunde</th>
            <td>{{ campaign.client }}</td>
        </tr>
        <tr>
            <th>Budget</th>
            <td>CHF {{ campaign.budget }}</td>
        </tr>
        <tr>
            <th>Startdatum</th>
            <td>{{ campaign.startDate ? campaign.startDate|date('d. F Y') : '' }}</td>
        </tr>
        <tr>
            <th>Enddatum</th>
            <td>{{ campaign.endDate ? campaign.endDate|date('d. F Y') : '' }}</td>
        </tr>

        {% if campaign.startDate and campaign.endDate %}
            <tr>
                <th>Laufzeit</th>
                <td>{{ date(campaign.endDate).diff(date(campaign.startDate)).days + 1 }} Tage</td>
            </tr>
        {% endif %}

        <tr>
            <th>Projektleiter/in</th>
            <td>{{ campaign.projectManager }}</td>
        </tr>
        <tr>
            <th>Owner Kampagne</th>
            <td>{{ campaign.campaignOwner }}</td>
        </tr>
        </tbody>
    </table>

    <div class="mb-5" id="campaign-description-container">
        <div class="card shadow-sm">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span class="fw-semibold text-muted">Notizen</span>

                {% if is_granted('CAMPAIGN_EDIT', campaign) %}
                    <button
                        type="button"
                        class="btn btn-sm btn-outline-primary"
                        id="button-show-edit-campaign-description-form"
                    >
                        Bearbeiten
                    </button>
                {% endif %}

            </div>

            <div class="card-body">
                <div
                    id="area-show-campaign-description"
                    class="campaign-description-content"
                >
                    {% if descriptionHTML is empty %}
                        Keine Notizen vorhanden.
                    {% else %}
                        {{ descriptionHTML|raw }}
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <form
        class="d-none mb-5"
        id="form-edit-campaign-description"
        action="{{ path('app_campaign_description_update', { id: campaign.id }) }}"
        method="post"
    >
        <input type="hidden" name="_token" value="{{ csrf_token('description' ~ campaign.id) }}">

        <div class="card shadow-sm">
            <div class="card-header">
                <span class="fw-semibold">Notizen bearbeiten</span>
            </div>

            <div class="card-body">
                <div class="mb-3">
                <textarea
                    name="campaign-description"
                    class="form-control"
                    id="textarea-edit-campaign-description"
                    rows="8"
                    placeholder="Hier können Notizen zur Kampagne ergänzt werden…"
                >{{ campaign.description }}</textarea>
                </div>

                {# --- Helper / Markdown hints --- #}
                <div class="alert alert-light border small mb-4">
                    <div class="fw-semibold mb-2 text-muted">Formatierung</div>
                    <ul class="mb-0 ps-3">
                        <li>
                            Link einfügen:
                            <code>[DuckDuckGo](https://duckduckgo.com)</code>
                        </li>
                    </ul>
                </div>

                {# --- Metadata --- #}
                {% if campaign.descriptionUpdatedAt is not null %}
                    <div class="text-muted small mb-4">
                        Zuletzt bearbeitet
                        {% if campaign.descriptionLastEditedBy is not null %}
                            von <strong>{{ campaign.descriptionLastEditedBy.email }}</strong>
                        {% endif %}
                        am {{ campaign.descriptionUpdatedAt|date('d.m.Y H:i') }}
                    </div>
                {% endif %}

                {# --- Actions --- #}
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Speichern</button>

                    <button
                        type="button"
                        class="btn btn-outline-secondary"
                        id="button-cancel-edit-campaign-description"
                    >
                        Abbrechen
                    </button>
                </div>
            </div>
        </div>
    </form>

    <div class="btn-group">
        <a class="btn btn-outline-primary" href="{{ path('app_campaign_index') }}">Zurück</a>

        {% if is_granted('CAMPAIGN_EDIT', campaign) %}
            <a class="btn btn-outline-primary"
               href="{{ path('app_campaign_edit', {'id': campaign.id}) }}">Kampagne bearbeiten</a>
        {% endif %}
    </div>

{% endblock %}
